@model TV5_VolunteerEventMgmtApp.ViewModels.DashboardVM
@Html.Partial("_ModalPartial")

@{
	ViewData["Title"] = "Dashboard";
}

<h1>@ViewData["Title"]</h1>

<hr />

<link href="~/css/dashboard.css" rel="stylesheet" />

<div class="dashboard-container">

	<!--Left-->
	<div class="left-panel">
		<div class="container my-5">
			<div class="action-buttons my-4 d-flex justify-content-center gap-5 flex-wrap"
				 style="max-width: 100%">

				@*<a asp-area="" asp-controller="AttendanceSheet" asp-action="Create" class="">
					<div class="big-link background-image-1">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Attendance Sheet</span>
						</div>
					</div>
				</a>
				<a asp-area="" asp-controller="CsvImport" asp-action="Index" class="">
					<div class="big-link background-image-2">
						<div class="link-box">
							<span style="font-size: .6em;">Upload</span>
							<span class="emp-text">Singer Data</span>
						</div>
					</div>
				</a>
				<a asp-area="" asp-controller="Director" asp-action="Create" class="">
					<div class="big-link background-image-3">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Director</span>
						</div>
					</div>
				</a>
				<a asp-area="" asp-controller="Location" asp-action="Create" class="">
					<div class="big-link background-image-4">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Location</span>
						</div>
					</div>
				</a>*@

				<!--Modal Test starts here-->
				<a href="#" class="open-modal" data-partial="_AttendanceSheetPartial" data-title="Create Attendance Sheet">
					<div class="big-link background-image-1">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Attendance Sheet</span>
						</div>
					</div>
				</a>

				<a href="#" class="open-modal" data-partial="_SingerPartial" data-title="Create a New Singer">
					<div class="big-link background-image-2">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Singer</span>
						</div>
					</div>
				</a>

				<a href="#" class="open-modal" data-partial="_CsvImportPartial" data-title="Upload Singer Data">
					<div class="big-link background-image-2">
						<div class="link-box">
							<span style="font-size: .6em;">Upload</span>
							<span class="emp-text">Singer Data</span>
						</div>
					</div>
				</a>

				<a href="#" class="open-modal" data-partial="_DirectorPartial" data-title="Create a New Director">
					<div class="big-link background-image-3">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Director</span>
						</div>
					</div>
				</a>

				<a href="#" class="open-modal" data-partial="_LocationPartial" data-title="Create a New Location">
					<div class="big-link background-image-4">
						<div class="link-box">
							<span style="font-size: .6em;">Create</span>
							<span class="emp-text">Location</span>
						</div>
					</div>
				</a>
				<!--Modal Test ends here-->
			</div>
		</div>

		<div class="dropdown mb-4">
			<label for="locationDropdown">Select Location:</label>
			<select id="locationDropdown" class="form-control">
				<option value="all" selected>All</option>
				@foreach (var location in Model.Locations)
				{
					<option value="@location.ID">@location.City</option>
				}
			</select>
		</div>
		<div class="counter-widget text-start">

			<div class="statistics my-3">
				<p>Total Singers: <span id="singerCount" class="text-purple fw-bold">0</span></p>

				<div id="specificLocationStats">
					<p>
						Average Attendance: <span id="mean" class="text-purple fw-bold">--</span>
						<span class="text-purple fw-bold">(<span id="percentageAttendance">--</span>%)</span>
					</p>
				</div>

				<div id="allLocationsStats" style="display: none;">
					<p>
						Highest Average Attendance: <span id="highestmean" class="text-purple fw-bold"></span>
						<span class="text-purple fw-bold">(<span id="highestPercentageAttendance"></span>%)</span> at <strong><span id="highestmeanLocation"></span></strong>
					</p>
					<p>
						Lowest Average Attendance: <span id="lowestmean" class="text-purple fw-bold"></span>
						<span class="text-purple fw-bold">(<span id="lowestPercentageAttendance"></span>%)</span> at <strong><span id="lowestmeanLocation"></span></strong>
					</p>
				</div>
			</div>
		</div>
		<div id="attendance-graph-container"></div>
	</div>

	<!--Right-->
	<div class="right-panel">
		<h2 class="fs-3 mb-4">Weekly Calendar</h2>

		<div class="calendar-container">
			<div id="calendar" class="fc-calendar"></div>
		</div>
	</div>
	
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="eventModalLabel">Event Details</h5>
			</div>
			<div class="modal-body">
				<!-- Content will be injected by JavaScript -->
			</div>
			<div class="modal-footer">
				<a href="#" id="detailsLink" class="btn btn-purple">View Details</a>
				<button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<style>
	.fc-list-event:hover {
		background-color: inherit !important;
		color: inherit !important;
		text-decoration: none !important;
	}
</style>

@section Scripts {
	<script src="~/js/dashboard.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<script>
		$(document).ready(function () {
			$('.open-modal').click(function (e) {
				e.preventDefault();

				var partialViewName = $(this).data('partial');
				var modalTitle = $(this).data('title');
				var modalId = 'dynamicModal';

				$('#' + modalId + ' .modal-title').text(modalTitle);

				// Use AJAX to load the partial view into the modal body
				$.ajax({
					url: '@Url.Action("LoadPartial", "Modal")',
					type: 'GET',
					data: { partialViewName: partialViewName },
					success: function (data) {
						$('#' + modalId + ' .modal-body').html(data);

						$('#' + modalId).modal('show');
					},
					error: function () {
						alert('Failed to load content. Please try again.');
					}
				});
			});

			// Handle form submission within the modal via event delegation
			$(document).on('submit', 'form', function (e) {
				e.preventDefault();

				var $form = $(this);
				var url = $form.attr('action');
				var method = $form.attr('method') || 'POST';

				$.ajax({
					url: url,
					type: method,
					data: $form.serialize(),
					success: function (response) {
						if (response.success) {
							$('#dynamicModal').modal('hide');
							alert(response.message);
						} else {
							var errorMessages = response.errors.join('\n');
							alert('Errors:\n' + errorMessages);
						}
					},
					error: function () {
						alert('An error occurred while submitting the form. Please try again.');
					}
				});
			});
		});
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
}